<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>DjangoRocket</title>
</head>
<body>
<h1>DjangoRocket launch page</h1>

<div id="gamepadDisplay"></div>
<div id="gamepadPrompt"></div>
<p>
<table>
    <tr>
        <td>&nbsp;</td>
        <td><input type="button" class="btn_move" id="btn_up" value="UP"/></td>
        <td>&nbsp;</td>
    </tr>
    <tr>
        <td><input type="button" class="btn_move" id="btn_left" value="LEFT"/></td>
        <td>Video here</td>
        <td><input type="button" class="btn_move" id="btn_right" value="RIGHT"/></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><input type="button" class="btn_move" id="btn_down" value="DOWN"/></td>
        <td>&nbsp;</td>
    </tr>
</table>
</p>
<p>
    <input type="button" id="btn_fire" value="FIRE"/><br>
    <input type="button" id="btn_laser" value="TOGGLE LASER"/>
</p>
</body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    //Ajax calls
    function moveTurret(direction, duration) {
        var data = {'direction': direction, 'magnitude': duration};
        console.log(data);
        $.get('/move', data, function (returndata) {
            console.log(returndata);
        });
    }
    function fireTurret(numberOfShots) {
        for (var i = 0; i < numberOfShots; i++) {
            $.get('/fire', function (returndata) {
                console.log(returndata);
            });
        }
    }
    $('.btn_move').click(function () {
        moveTurret(this.value, 10);
    });
    $('#btn_fire').click(function () {
        fireTurret(1);
    });
</script>
<script>
    //Gamepad support
    var hasGP = false;
    var repGP;

    function canGame() {
        return "getGamepads" in navigator;
    }

    function gamepadControls() {
        var gp = navigator.getGamepads()[0];


        for (var i = 0; i < gp.buttons.length; i++) {
            if (gp.buttons[i].pressed) {
                console.log(i + "pressed");
            }
        }
        if (gp.buttons[4].pressed) {
            console.log("FIRE!");
            fireTurret(1);
        }


        for (var i = 0; i < gp.axes.length; i += 2) {
            var X = gp.axes[i];
            var Y = gp.axes[i + 1];
            if (X == -1) {
                console.log('LEFT');
                moveTurret('LEFT', 10);
            }
            if (X == 1) {
                console.log('RIGHT');
                moveTurret('RIGHT', 10);
            }
            if (Y == -1) {
                moveTurret('UP', 10);
                console.log('UP');
            }
            if (Y == 1) {
                moveTurret('DOWN', 10);
                console.log('DOWN');
            }
        }
    }

    $(document).ready(function () {

        if (canGame()) {

            var prompt = "To begin using your gamepad, connect it and press any button!";
            $("#gamepadPrompt").text(prompt);

            $(window).on("gamepadconnected", function () {
                hasGP = true;
                $("#gamepadPrompt").html("Gamepad connected!");
                console.log("connection event");
                repGP = window.setInterval(gamepadControls, 100);
            });

            $(window).on("gamepaddisconnected", function () {
                console.log("disconnection event");
                $("#gamepadPrompt").text(prompt);
                window.clearInterval(repGP);
            });

            //setup an interval for Chrome
            var checkGP = window.setInterval(function () {
                console.log('checkGP');
                if (navigator.getGamepads()[0]) {
                    if (!hasGP) $(window).trigger("gamepadconnected");
                    window.clearInterval(checkGP);
                }
            }, 500);
        }

    });
</script>
</html>